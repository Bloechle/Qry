<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopBox Session Analyzer - Qry</title>
    <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/Bloechle/qry@latest/svg/qry-logo-white.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        unifr: "#005395",
                        topbox: "#8b5cf6",
                        dark: { 100: "#0a0a0a", 200: "#1a1a1a", 300: "#2d2d30", 400: "#3e3e42", 500: "#52525b" }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            .btn { @apply inline-flex items-center gap-2 px-4 py-2.5 rounded-lg transition-all duration-200 font-medium; }
            .btn-primary { @apply bg-topbox hover:bg-topbox/90 text-white focus:ring-2 focus:ring-topbox/50; }
            .btn-secondary { @apply bg-unifr hover:bg-unifr/90 text-white focus:ring-2 focus:ring-unifr/50; }
            .card { @apply bg-dark-200 border border-dark-300 rounded-xl p-6 shadow-lg; }
            .stat-card { @apply bg-dark-300 border-l-4 rounded-lg p-4 text-center; }
            .drop-zone { @apply border-2 border-dashed border-dark-400 rounded-xl bg-dark-200/50 transition-all; }
            .drop-zone.active { @apply border-topbox bg-topbox/5; }
        }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>

<body class="bg-dark-100 text-gray-100 min-h-screen antialiased">

<header class="bg-dark-200 border-b border-dark-300 sticky top-0 z-40 backdrop-blur-sm bg-dark-200/95">
    <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-topbox rounded-lg flex items-center justify-center">
                    <i data-lucide="target" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-white">TopBox Analyzer</h1>
                    <p class="text-sm text-gray-400">Reaction Time Analysis</p>
                </div>
            </div>
            <div class="flex gap-3" id="header-actions" style="display: none;">
                <button id="export-btn" class="btn btn-secondary">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Export CSV
                </button>
                <button id="reset-btn" class="btn btn-primary">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    Reset
                </button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8">

    <div id="drop-zone-container">
        <div id="drop-zone" class="drop-zone min-h-96 flex items-center justify-center cursor-pointer">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-6 bg-dark-300 rounded-xl flex items-center justify-center">
                    <i data-lucide="file-up" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-semibold mb-2">Drop TopBox Session JSON File</h2>
                <p class="text-gray-400 mb-6">or click to browse</p>
                <button id="browse-btn" class="btn btn-primary">
                    <i data-lucide="folder-open" class="w-4 h-4"></i>
                    Browse Files
                </button>
                <p class="text-xs text-gray-500 mt-4">Supports: TopBox session JSON exports</p>
            </div>
        </div>
    </div>

    <div id="results-container" style="display: none;">

        <!-- Session Info -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold mb-4">Session Information</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm" id="session-info"></div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="stat-card border-topbox">
                <div class="text-3xl font-bold mb-1 text-topbox" id="stat-total">0</div>
                <div class="text-gray-400 text-sm">Total Trials</div>
            </div>
            <div class="stat-card border-green-500">
                <div class="text-3xl font-bold mb-1 text-green-400" id="stat-valid">0</div>
                <div class="text-gray-400 text-sm">Valid Trials</div>
            </div>
            <div class="stat-card border-blue-500">
                <div class="text-3xl font-bold mb-1 text-blue-400" id="stat-rt">0ms</div>
                <div class="text-gray-400 text-sm">Avg RT</div>
            </div>
            <div class="stat-card border-purple-500">
                <div class="text-3xl font-bold mb-1 text-purple-400" id="stat-move">0ms</div>
                <div class="text-gray-400 text-sm">Avg Move</div>
            </div>
            <div class="stat-card border-orange-500">
                <div class="text-3xl font-bold mb-1 text-orange-400" id="stat-hands">0/0</div>
                <div class="text-gray-400 text-sm">L/R Hits</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="flex gap-4 items-center">
                <label class="text-gray-300">
                    <span class="mr-2">Filter:</span>
                    <select id="filter-valid" class="bg-dark-400 rounded px-3 py-1.5 border border-dark-500">
                        <option value="all">All Trials</option>
                        <option value="valid">Valid Only</option>
                        <option value="invalid">Invalid Only</option>
                    </select>
                </label>
                <div class="ml-auto text-gray-400 text-sm">
                    Click trial row to view acceleration details
                </div>
            </div>
        </div>

        <!-- Trials Table -->
        <div class="card mb-6">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b border-dark-300">
                    <tr class="text-left text-gray-400">
                        <th class="p-3 cursor-pointer hover:text-white" data-sort="id">
                            ID <i data-lucide="arrow-up-down" class="w-3 h-3 inline"></i>
                        </th>
                        <th class="p-3 cursor-pointer hover:text-white" data-sort="target">
                            Target <i data-lucide="arrow-up-down" class="w-3 h-3 inline"></i>
                        </th>
                        <th class="p-3 cursor-pointer hover:text-white" data-sort="hitHand">
                            Hit Hand <i data-lucide="arrow-up-down" class="w-3 h-3 inline"></i>
                        </th>
                        <th class="p-3 cursor-pointer hover:text-white" data-sort="moveTime">
                            Move Time <i data-lucide="arrow-up-down" class="w-3 h-3 inline"></i>
                        </th>
                        <th class="p-3 cursor-pointer hover:text-white" data-sort="hitTime">
                            RT <i data-lucide="arrow-up-down" class="w-3 h-3 inline"></i>
                        </th>
                        <th class="p-3">Valid</th>
                    </tr>
                    </thead>
                    <tbody id="trials-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Trial Detail -->
        <div id="trial-detail" class="hidden">
            <div class="card">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold">Trial Detail</h3>
                        <p class="text-sm text-gray-400" id="trial-info"></p>
                    </div>
                    <button id="close-detail" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Close
                    </button>
                </div>
                <div id="chart"></div>
            </div>
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="card text-center">
            <div class="w-8 h-8 border-2 border-gray-600 border-t-topbox rounded-full mx-auto mb-4 animate-spin"></div>
            <p class="text-gray-300">Loading session...</p>
        </div>
    </div>

</main>

<input type="file" id="file-input" accept=".json" class="hidden">

<script type="module">
    import $ from 'https://cdn.jsdelivr.net/gh/Bloechle/qry@latest/Qry.js';
    import { QryApp } from 'https://cdn.jsdelivr.net/gh/Bloechle/qry@latest/QryApp.js';

    class TopBoxAnalyzer extends QryApp {
        #data = null;
        #selectedTrial = null;
        #sortField = 'id';
        #sortAsc = true;
        #filterValid = 'all';

        constructor() {
            super({ title: 'TopBox Analyzer', logLevel: 'info' });
            this.#init();
        }

        #init() {
            this.#setupDragDrop();
            this.bindAll({
                '#browse-btn': () => $('#file-input').el.click(),
                '#reset-btn': () => this.#reset(),
                '#export-btn': () => this.#exportCSV(),
                '#file-input': { event: 'change', handler: (e) => this.#handleFile(e) },
                '#filter-valid': { event: 'change', handler: () => this.#renderTrials() },
                '#close-detail': () => this.#hideDetail()
            });
        }

        #setupDragDrop() {
            const dropZone = $('#drop-zone').el;

            dropZone.addEventListener('click', () => $('#file-input').el.click());

            ['dragenter', 'dragover'].forEach(evt => {
                dropZone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    $('#drop-zone').cls('+active');
                });
            });

            ['dragleave', 'drop'].forEach(evt => {
                dropZone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    $('#drop-zone').cls('-active');
                });
            });

            dropZone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file) this.#loadFile(file);
            });
        }

        #handleFile(e) {
            const file = e.target.files[0];
            if (file) this.#loadFile(file);
        }

        async #loadFile(file) {
            if (!file.name.endsWith('.json')) {
                this.error('Please upload a JSON file');
                return;
            }

            $('#loading').cls('-hidden');

            try {
                const text = await file.text();
                this.#data = JSON.parse(text);

                if (!this.#data.trials || !Array.isArray(this.#data.trials)) {
                    throw new Error('Invalid session format');
                }

                this.success(`Loaded ${this.#data.trials.length} trials`);
                this.#showResults();
            } catch (err) {
                this.error('Invalid JSON file: ' + err.message);
            } finally {
                $('#loading').cls('+hidden');
            }
        }

        #showResults() {
            $('#drop-zone-container').hide();
            $('#results-container').show();
            $('#header-actions').show();

            this.#renderSessionInfo();
            this.#renderStats();
            this.#renderTrials();
            this.#setupTableEvents();

            this.refreshIcons();
        }

        #renderSessionInfo() {
            const html = `
                <div>
                    <div class="text-gray-400">Player</div>
                    <div class="text-white font-medium">${this.#data.playerName}</div>
                </div>
                <div>
                    <div class="text-gray-400">Date</div>
                    <div class="text-white font-medium">${this.#formatDate(this.#data.startTime)}</div>
                </div>
                <div>
                    <div class="text-gray-400">Frequency</div>
                    <div class="text-white font-medium">${this.#data.unityFrequency}Hz</div>
                </div>
                <div>
                    <div class="text-gray-400">Completed</div>
                    <div class="text-white font-medium">${this.#data.completed ? '✓ Yes' : '✗ No'}</div>
                </div>
            `;
            $('#session-info').html(html);
        }

        #renderStats() {
            const stats = this.#calculateStats();
            $('#stat-total').text(stats.total);
            $('#stat-valid').text(stats.validCount);
            $('#stat-rt').text(stats.avgRT + 'ms');
            $('#stat-move').text(stats.avgMove + 'ms');
            $('#stat-hands').text(`${stats.leftHits}/${stats.rightHits}`);
        }

        #renderTrials() {
            this.#filterValid = $('#filter-valid').el.value;
            let trials = [...this.#data.trials];

            if (this.#filterValid === 'valid') {
                trials = trials.filter(t => t.isValid);
            } else if (this.#filterValid === 'invalid') {
                trials = trials.filter(t => !t.isValid);
            }

            trials.sort((a, b) => {
                let valA = a[this.#sortField];
                let valB = b[this.#sortField];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                return this.#sortAsc ?
                    (valA < valB ? -1 : 1) :
                    (valA > valB ? -1 : 1);
            });

            const html = trials.map(t => `
                <tr class="border-b border-dark-300 hover:bg-dark-300/30 cursor-pointer transition-colors" data-trial-id="${t.id}">
                    <td class="p-3 font-mono text-gray-300">#${t.id}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                t.target === 'right'
                    ? 'bg-green-500/20 text-green-400'
                    : 'bg-blue-500/20 text-blue-400'
            }">
                            ${t.target}
                        </span>
                    </td>
                    <td class="p-3 text-gray-300">${t.hitHand || '-'}</td>
                    <td class="p-3 font-mono text-gray-300">${t.moveTime ? t.moveTime + 'ms' : '-'}</td>
                    <td class="p-3 font-mono text-gray-300">${t.hitTime > 0 ? t.hitTime + 'ms' : '-'}</td>
                    <td class="p-3">
                        ${t.isValid ?
                '<span class="text-green-400 text-lg">✓</span>' :
                '<span class="text-red-400 text-lg">✗</span>'}
                    </td>
                </tr>
            `).join('');

            $('#trials-body').html(html);

            $('tr[data-trial-id]').on('click', (e) => {
                const id = parseInt($(e.currentTarget).attr('data-trial-id'));
                this.#showTrialDetail(id);
            });
        }

        #setupTableEvents() {
            $('th[data-sort]').on('click', (e) => {
                const field = $(e.currentTarget).attr('data-sort');
                if (this.#sortField === field) {
                    this.#sortAsc = !this.#sortAsc;
                } else {
                    this.#sortField = field;
                    this.#sortAsc = true;
                }
                this.#renderTrials();
            });
        }

        #showTrialDetail(trialId) {
            const trial = this.#data.trials.find(t => t.id === trialId);
            if (!trial) return;

            this.#selectedTrial = trial;
            $('#trial-detail').cls('-hidden');

            $('#trial-info').text(
                `Trial #${trial.id} • Target: ${trial.target} • Hit: ${trial.hitHand || 'None'} • RT: ${trial.hitTime}ms`
            );

            setTimeout(() => {
                $('#trial-detail').el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            this.#renderChart();
            this.refreshIcons();
        }

        #hideDetail() {
            $('#trial-detail').cls('+hidden');
            this.#selectedTrial = null;
        }

        #renderChart() {
            const trial = this.#selectedTrial;
            $('#chart').html('');

            const margin = { top: 20, right: 80, bottom: 50, left: 80 };
            const width = $('#chart').el.clientWidth - margin.left - margin.right;
            const height = 400;

            const svg = d3.select('#chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain([0, trial.samplingIndex - 1])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, 10000])
                .range([height, 0]);

            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));

            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .style('color', '#9CA3AF');

            svg.append('g')
                .call(d3.axisLeft(yScale))
                .style('color', '#9CA3AF');

            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height + 40)
                .attr('text-anchor', 'middle')
                .style('fill', '#9CA3AF')
                .text('Sample Index');

            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -60)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .style('fill', '#9CA3AF')
                .text('Acceleration (mg)');

            const line = d3.line()
                .x((d, i) => xScale(i))
                .y(d => yScale(d))
                .curve(d3.curveMonotoneX);

            svg.append('path')
                .datum(trial.accLeft.slice(0, trial.samplingIndex))
                .attr('fill', 'none')
                .attr('stroke', '#3B82F6')
                .attr('stroke-width', 2)
                .attr('d', line);

            svg.append('path')
                .datum(trial.accRight.slice(0, trial.samplingIndex))
                .attr('fill', 'none')
                .attr('stroke', '#10B981')
                .attr('stroke-width', 2)
                .attr('d', line);

            svg.append('path')
                .datum(trial.accBob.slice(0, trial.samplingIndex))
                .attr('fill', 'none')
                .attr('stroke', '#F59E0B')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('d', line);

            const legend = svg.append('g')
                .attr('transform', `translate(${width - 120}, 10)`);

            const legendData = [
                { color: '#3B82F6', label: 'Left Hand' },
                { color: '#10B981', label: 'Right Hand' },
                { color: '#F59E0B', label: 'Head', dash: true }
            ];

            legendData.forEach((item, i) => {
                const y = i * 20;
                const line = legend.append('line')
                    .attr('x1', 0).attr('x2', 30)
                    .attr('y1', y).attr('y2', y)
                    .attr('stroke', item.color)
                    .attr('stroke-width', 2);

                if (item.dash) line.attr('stroke-dasharray', '5,5');

                legend.append('text')
                    .attr('x', 35).attr('y', y + 4)
                    .style('fill', '#9CA3AF')
                    .style('font-size', '12px')
                    .text(item.label);
            });

            if (trial.stimulusTime > 0) {
                const stimIdx = Math.floor(trial.stimulusTime / 10);
                svg.append('line')
                    .attr('x1', xScale(stimIdx))
                    .attr('x2', xScale(stimIdx))
                    .attr('y1', 0)
                    .attr('y2', height)
                    .attr('stroke', '#EF4444')
                    .attr('stroke-width', 2)
                    .attr('stroke-dasharray', '3,3');
            }
        }

        #calculateStats() {
            const trials = this.#data.trials;
            const validTrials = trials.filter(t => t.isValid);

            const rts = validTrials.filter(t => t.hitTime > 0).map(t => t.hitTime);
            const moves = validTrials.filter(t => t.moveTime > 0).map(t => t.moveTime);

            return {
                total: trials.length,
                validCount: validTrials.length,
                validRate: Math.round(validTrials.length / trials.length * 100),
                avgRT: rts.length ? Math.round(rts.reduce((a,b) => a+b, 0) / rts.length) : 0,
                avgMove: moves.length ? Math.round(moves.reduce((a,b) => a+b, 0) / moves.length) : 0,
                leftHits: trials.filter(t => t.hitHand === 'Left').length,
                rightHits: trials.filter(t => t.hitHand === 'Right').length
            };
        }

        #formatDate(dateStr) {
            return dateStr.replace('_', ' ').replace(/-/g, '/');
        }

        #exportCSV() {
            const trials = this.#data.trials;
            const headers = ['ID', 'Target', 'Hit Hand', 'Move Time', 'Hit Time', 'Valid'];
            const rows = trials.map(t => [
                t.id,
                t.target,
                t.hitHand || '',
                t.moveTime || '',
                t.hitTime || '',
                t.isValid ? 'Valid' : 'Invalid'
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `topbox_${this.#data.playerName}_${this.#data.startTime}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            this.success('CSV exported');
        }

        #reset() {
            this.#data = null;
            this.#selectedTrial = null;
            $('#drop-zone-container').show();
            $('#results-container').hide();
            $('#header-actions').hide();
            $('#file-input').el.value = '';
            this.info('Reset complete');
        }
    }

    new TopBoxAnalyzer();
</script>
</body>
</html>