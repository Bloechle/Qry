<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopBox Multi-Session Analyzer - Qry</title>
    <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/Bloechle/qry@latest/svg/qry-logo-white.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        unifr: "#005395",
                        topbox: "#8b5cf6",
                        dark: { 100: "#0a0a0a", 200: "#1a1a1a", 300: "#2d2d30", 400: "#3e3e42", 500: "#52525b" }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            .btn { @apply inline-flex items-center gap-2 px-4 py-2.5 rounded-lg transition-all duration-200 font-medium; }
            .btn-primary { @apply bg-topbox hover:bg-topbox/90 text-white focus:ring-2 focus:ring-topbox/50; }
            .btn-secondary { @apply bg-unifr hover:bg-unifr/90 text-white focus:ring-2 focus:ring-unifr/50; }
            .card { @apply bg-dark-200 border border-dark-300 rounded-xl p-6 shadow-lg; }
            .stat-card { @apply bg-dark-300 border-l-4 rounded-lg p-4 text-center; }
            .drop-zone { @apply border-2 border-dashed border-dark-400 rounded-xl bg-dark-200/50 transition-all; }
            .drop-zone.active { @apply border-topbox bg-topbox/5; }
            .session-badge { @apply inline-flex items-center px-2 py-1 rounded text-xs font-medium; }
        }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>

<body class="bg-dark-100 text-gray-100 min-h-screen antialiased">

<header class="bg-dark-200 border-b border-dark-300 sticky top-0 z-40 backdrop-blur-sm bg-dark-200/95">
    <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-topbox rounded-lg flex items-center justify-center">
                    <i data-lucide="layers" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-white">TopBox Multi-Session Analyzer</h1>
                    <p class="text-sm text-gray-400">Batch Analysis & Comparison</p>
                </div>
            </div>
            <div class="flex gap-3" id="header-actions" style="display: none;">
                <button id="export-all-btn" class="btn btn-secondary">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Export All
                </button>
                <button id="reset-btn" class="btn btn-primary">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    Reset
                </button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8">

    <div id="drop-zone-container">
        <div id="drop-zone" class="drop-zone min-h-96 flex items-center justify-center cursor-pointer">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-6 bg-dark-300 rounded-xl flex items-center justify-center">
                    <i data-lucide="files" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-semibold mb-2">Drop Multiple TopBox JSON Files</h2>
                <p class="text-gray-400 mb-6">or click to browse (supports 100+ files)</p>
                <button id="browse-btn" class="btn btn-primary">
                    <i data-lucide="folder-open" class="w-4 h-4"></i>
                    Browse Files
                </button>
                <p class="text-xs text-gray-500 mt-4">Files like: 80_Martin_Briw_Dyn_2025-11-12_18h14.json</p>
            </div>
        </div>
    </div>

    <div id="results-container" style="display: none;">

        <!-- Overview Stats -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="stat-card border-topbox">
                <div class="text-3xl font-bold mb-1 text-topbox" id="stat-sessions">0</div>
                <div class="text-gray-400 text-sm">Sessions</div>
            </div>
            <div class="stat-card border-blue-500">
                <div class="text-3xl font-bold mb-1 text-blue-400" id="stat-participants">0</div>
                <div class="text-gray-400 text-sm">Participants</div>
            </div>
            <div class="stat-card border-green-500">
                <div class="text-3xl font-bold mb-1 text-green-400" id="stat-total-trials">0</div>
                <div class="text-gray-400 text-sm">Total Trials</div>
            </div>
            <div class="stat-card border-purple-500">
                <div class="text-3xl font-bold mb-1 text-purple-400" id="stat-avg-rt">0ms</div>
                <div class="text-gray-400 text-sm">Avg RT (All)</div>
            </div>
            <div class="stat-card border-orange-500">
                <div class="text-3xl font-bold mb-1 text-orange-400" id="stat-conditions">0</div>
                <div class="text-gray-400 text-sm">Conditions</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-6">
            <h3 class="text-lg font-bold mb-4">Filters & Grouping</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <label class="text-gray-300">
                    <span class="text-sm mb-1 block">Participant</span>
                    <select id="filter-participant" class="w-full bg-dark-400 rounded px-3 py-2 border border-dark-500">
                        <option value="all">All Participants</option>
                    </select>
                </label>
                <label class="text-gray-300">
                    <span class="text-sm mb-1 block">Condition</span>
                    <select id="filter-condition" class="w-full bg-dark-400 rounded px-3 py-2 border border-dark-500">
                        <option value="all">All Conditions</option>
                    </select>
                </label>
                <label class="text-gray-300">
                    <span class="text-sm mb-1 block">Target Size</span>
                    <select id="filter-size" class="w-full bg-dark-400 rounded px-3 py-2 border border-dark-500">
                        <option value="all">All Sizes</option>
                    </select>
                </label>
                <label class="text-gray-300">
                    <span class="text-sm mb-1 block">Valid Only</span>
                    <select id="filter-valid" class="w-full bg-dark-400 rounded px-3 py-2 border border-dark-500">
                        <option value="all">All Trials</option>
                        <option value="valid">Valid Only</option>
                        <option value="invalid">Invalid Only</option>
                    </select>
                </label>
            </div>
        </div>

        <!-- Sessions List -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">Sessions</h3>
                <span class="text-sm text-gray-400" id="session-count">0 sessions loaded</span>
            </div>
            <div id="sessions-list" class="space-y-2"></div>
        </div>

        <!-- Comparison Chart -->
        <div class="card mb-6" id="comparison-section" style="display: none;">
            <h3 class="text-lg font-bold mb-4">Performance Comparison</h3>
            <div id="comparison-chart"></div>
        </div>

        <!-- Trial Detail (when session selected) -->
        <div id="trial-detail" class="hidden">
            <div class="card">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold">Trial Detail</h3>
                        <p class="text-sm text-gray-400" id="trial-info"></p>
                    </div>
                    <button id="close-detail" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Close
                    </button>
                </div>
                <div id="chart"></div>
            </div>
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="card text-center">
            <div class="w-8 h-8 border-2 border-gray-600 border-t-topbox rounded-full mx-auto mb-4 animate-spin"></div>
            <p class="text-gray-300" id="loading-text">Processing files...</p>
        </div>
    </div>

</main>

<input type="file" id="file-input" accept=".json" multiple class="hidden">

<script type="module">
    import $ from 'https://cdn.jsdelivr.net/gh/Bloechle/qry@latest/Qry.js';
    import { QryApp } from 'https://cdn.jsdelivr.net/gh/Bloechle/qry@latest/QryApp.js';

    class TopBoxMultiAnalyzer extends QryApp {
        #sessions = [];
        #selectedTrial = null;
        #filters = { participant: 'all', condition: 'all', size: 'all', valid: 'all' };

        constructor() {
            super({ title: 'TopBox Multi-Analyzer', logLevel: 'info' });
            this.#init();
        }

        #init() {
            this.#setupDragDrop();
            this.bindAll({
                '#browse-btn': () => $('#file-input').el.click(),
                '#reset-btn': () => this.#reset(),
                '#export-all-btn': () => this.#exportAll(),
                '#file-input': { event: 'change', handler: (e) => this.#handleFiles(e) },
                '#filter-participant': { event: 'change', handler: () => this.#applyFilters() },
                '#filter-condition': { event: 'change', handler: () => this.#applyFilters() },
                '#filter-size': { event: 'change', handler: () => this.#applyFilters() },
                '#filter-valid': { event: 'change', handler: () => this.#applyFilters() },
                '#close-detail': () => this.#hideDetail()
            });
        }

        #setupDragDrop() {
            const dropZone = $('#drop-zone').el;

            dropZone.addEventListener('click', () => $('#file-input').el.click());

            ['dragenter', 'dragover'].forEach(evt => {
                dropZone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    $('#drop-zone').cls('+active');
                });
            });

            ['dragleave', 'drop'].forEach(evt => {
                dropZone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    $('#drop-zone').cls('-active');
                });
            });

            dropZone.addEventListener('drop', (e) => {
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.json'));
                if (files.length > 0) this.#processFiles(files);
            });
        }

        #handleFiles(e) {
            const files = Array.from(e.target.files).filter(f => f.name.endsWith('.json'));
            if (files.length > 0) this.#processFiles(files);
        }

        async #processFiles(files) {
            $('#loading').cls('-hidden');
            $('#loading-text').text(`Processing ${files.length} files...`);

            try {
                for (let i = 0; i < files.length; i++) {
                    $('#loading-text').text(`Processing file ${i + 1}/${files.length}...`);
                    await this.#loadFile(files[i]);
                }

                this.success(`Loaded ${files.length} sessions`);
                this.#showResults();
            } catch (err) {
                this.error('Failed to process files: ' + err.message);
            } finally {
                $('#loading').cls('+hidden');
            }
        }

        async #loadFile(file) {
            const text = await file.text();
            const data = JSON.parse(text);

            // Parse filename: 80_Martin_Briw_Dyn_2025-11-12_18h14.json
            const meta = this.#parseFilename(file.name);

            const session = {
                filename: file.name,
                meta,
                config: data.config,
                trials: data.trials || (data.trial ? [data.trial] : []),
                stats: null
            };

            session.stats = this.#calculateSessionStats(session.trials);
            this.#sessions.push(session);
        }

        #parseFilename(filename) {
            // Pattern: [size]_[participant]_[condition]_[date]_[time].json
            const parts = filename.replace('.json', '').split('_');

            if (parts.length >= 5) {
                return {
                    size: parts[0],
                    participant: parts[1] + (parts[2] && !parts[2].match(/^\d/) ? '_' + parts[2] : ''),
                    condition: parts.length === 6 ? parts[3] : parts[2],
                    date: parts.length === 6 ? parts[4] : parts[3],
                    time: parts.length === 6 ? parts[5] : parts[4]
                };
            }

            // Fallback
            return {
                size: 'unknown',
                participant: filename.split('_')[1] || 'unknown',
                condition: 'unknown',
                date: 'unknown',
                time: 'unknown'
            };
        }

        #calculateSessionStats(trials) {
            const validTrials = trials.filter(t => t.isValid);
            const rts = validTrials.filter(t => t.hitTime > 0).map(t => t.hitTime);
            const moves = validTrials.filter(t => t.moveTime > 0).map(t => t.moveTime);

            return {
                total: trials.length,
                valid: validTrials.length,
                avgRT: rts.length ? Math.round(rts.reduce((a, b) => a + b, 0) / rts.length) : 0,
                avgMove: moves.length ? Math.round(moves.reduce((a, b) => a + b, 0) / moves.length) : 0,
                leftHits: trials.filter(t => t.hitHand === 'Left').length,
                rightHits: trials.filter(t => t.hitHand === 'Right').length
            };
        }

        #showResults() {
            $('#drop-zone-container').hide();
            $('#results-container').show();
            $('#header-actions').show();

            this.#updateOverviewStats();
            this.#populateFilters();
            this.#renderSessions();
            this.#renderComparison();

            this.refreshIcons();
        }

        #updateOverviewStats() {
            const participants = new Set(this.#sessions.map(s => s.meta.participant));
            const conditions = new Set(this.#sessions.map(s => s.meta.condition));
            const totalTrials = this.#sessions.reduce((sum, s) => sum + s.stats.total, 0);
            const allRTs = this.#sessions.flatMap(s =>
                s.trials.filter(t => t.isValid && t.hitTime > 0).map(t => t.hitTime)
            );
            const avgRT = allRTs.length ? Math.round(allRTs.reduce((a, b) => a + b, 0) / allRTs.length) : 0;

            $('#stat-sessions').text(this.#sessions.length);
            $('#stat-participants').text(participants.size);
            $('#stat-total-trials').text(totalTrials);
            $('#stat-avg-rt').text(avgRT + 'ms');
            $('#stat-conditions').text(conditions.size);
        }

        #populateFilters() {
            const participants = [...new Set(this.#sessions.map(s => s.meta.participant))].sort();
            const conditions = [...new Set(this.#sessions.map(s => s.meta.condition))].sort();
            const sizes = [...new Set(this.#sessions.map(s => s.meta.size))].sort();

            $('#filter-participant').html(
                '<option value="all">All Participants</option>' +
                participants.map(p => `<option value="${p}">${p}</option>`).join('')
            );

            $('#filter-condition').html(
                '<option value="all">All Conditions</option>' +
                conditions.map(c => `<option value="${c}">${c}</option>`).join('')
            );

            $('#filter-size').html(
                '<option value="all">All Sizes</option>' +
                sizes.map(s => `<option value="${s}">${s}mm</option>`).join('')
            );
        }

        #applyFilters() {
            this.#filters = {
                participant: $('#filter-participant').val(),
                condition: $('#filter-condition').val(),
                size: $('#filter-size').val(),
                valid: $('#filter-valid').val()
            };

            this.#renderSessions();
            this.#renderComparison();
        }

        #getFilteredSessions() {
            return this.#sessions.filter(s => {
                if (this.#filters.participant !== 'all' && s.meta.participant !== this.#filters.participant) return false;
                if (this.#filters.condition !== 'all' && s.meta.condition !== this.#filters.condition) return false;
                if (this.#filters.size !== 'all' && s.meta.size !== this.#filters.size) return false;
                return true;
            });
        }

        #renderSessions() {
            const filtered = this.#getFilteredSessions();
            $('#session-count').text(`${filtered.length} of ${this.#sessions.length} sessions`);

            const html = filtered.map((session, idx) => {
                const validPercent = Math.round((session.stats.valid / session.stats.total) * 100);

                return `
                    <div class="bg-dark-300 rounded-lg p-4 hover:bg-dark-400 transition-colors cursor-pointer" data-session-idx="${this.#sessions.indexOf(session)}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-semibold text-white">${session.meta.participant}</span>
                                    <span class="session-badge bg-blue-500/20 text-blue-400">${session.meta.condition}</span>
                                    <span class="session-badge bg-purple-500/20 text-purple-400">${session.meta.size}mm</span>
                                    <span class="text-xs text-gray-500">${session.meta.date} ${session.meta.time}</span>
                                </div>
                                <div class="grid grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">Trials:</span>
                                        <span class="text-white ml-1">${session.stats.total} (${validPercent}% valid)</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Avg RT:</span>
                                        <span class="text-white ml-1">${session.stats.avgRT}ms</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Avg Move:</span>
                                        <span class="text-white ml-1">${session.stats.avgMove}ms</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">L/R:</span>
                                        <span class="text-white ml-1">${session.stats.leftHits}/${session.stats.rightHits}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm ml-4" data-export-session="${this.#sessions.indexOf(session)}">
                                <i data-lucide="download" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            $('#sessions-list').html(html);

            // Bind events
            $('[data-session-idx]').on('click', (e) => {
                if ($(e.target).closest('[data-export-session]').exists) return;
                const idx = parseInt($(e.currentTarget).attr('data-session-idx'));
                this.#showSessionDetail(idx);
            });

            $('[data-export-session]').on('click', (e) => {
                e.stopPropagation();
                const idx = parseInt($(e.currentTarget).attr('data-export-session'));
                this.#exportSession(idx);
            });

            this.refreshIcons();
        }

        #renderComparison() {
            const filtered = this.#getFilteredSessions();
            if (filtered.length < 2) {
                $('#comparison-section').hide();
                return;
            }

            $('#comparison-section').show();
            $('#comparison-chart').html('');

            const margin = { top: 20, right: 80, bottom: 100, left: 60 };
            const width = $('#comparison-chart').el.clientWidth - margin.left - margin.right;
            const height = 400;

            const svg = d3.select('#comparison-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const data = filtered.map(s => ({
                label: `${s.meta.participant}_${s.meta.condition}_${s.meta.size}`,
                rt: s.stats.avgRT,
                move: s.stats.avgMove,
                valid: (s.stats.valid / s.stats.total) * 100
            }));

            const xScale = d3.scaleBand()
                .domain(data.map(d => d.label))
                .range([0, width])
                .padding(0.2);

            const yScale = d3.scaleLinear()
                .domain([0, Math.max(...data.map(d => Math.max(d.rt, d.move)))])
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));

            // Axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end')
                .style('fill', '#9CA3AF');

            svg.append('g')
                .call(d3.axisLeft(yScale))
                .style('color', '#9CA3AF');

            // RT bars
            svg.selectAll('.bar-rt')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar-rt')
                .attr('x', d => xScale(d.label))
                .attr('y', d => yScale(d.rt))
                .attr('width', xScale.bandwidth() / 2)
                .attr('height', d => height - yScale(d.rt))
                .attr('fill', '#3B82F6');

            // Move bars
            svg.selectAll('.bar-move')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar-move')
                .attr('x', d => xScale(d.label) + xScale.bandwidth() / 2)
                .attr('y', d => yScale(d.move))
                .attr('width', xScale.bandwidth() / 2)
                .attr('height', d => height - yScale(d.move))
                .attr('fill', '#10B981');

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width - 100}, 0)`);

            legend.append('rect')
                .attr('x', 0).attr('y', 0)
                .attr('width', 15).attr('height', 15)
                .attr('fill', '#3B82F6');
            legend.append('text')
                .attr('x', 20).attr('y', 12)
                .style('fill', '#9CA3AF')
                .style('font-size', '12px')
                .text('RT');

            legend.append('rect')
                .attr('x', 0).attr('y', 20)
                .attr('width', 15).attr('height', 15)
                .attr('fill', '#10B981');
            legend.append('text')
                .attr('x', 20).attr('y', 32)
                .style('fill', '#9CA3AF')
                .style('font-size', '12px')
                .text('Move');
        }

        #showSessionDetail(sessionIdx) {
            const session = this.#sessions[sessionIdx];
            this.#selectedTrial = session.trials[0]; // Show first trial

            $('#trial-detail').cls('-hidden');
            $('#trial-info').text(
                `Session: ${session.meta.participant} - ${session.meta.condition} - ${session.meta.size}mm`
            );

            setTimeout(() => {
                $('#trial-detail').el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            this.#renderChart();
            this.refreshIcons();
        }

        #hideDetail() {
            $('#trial-detail').cls('+hidden');
            this.#selectedTrial = null;
        }

        #renderChart() {
            const trial = this.#selectedTrial;
            if (!trial) return;

            $('#chart').html('');

            const margin = { top: 20, right: 80, bottom: 50, left: 80 };
            const width = $('#chart').el.clientWidth - margin.left - margin.right;
            const height = 400;

            const svg = d3.select('#chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const validIdx = trial.samplingIndex || 100;

            const xScale = d3.scaleLinear()
                .domain([0, validIdx - 1])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, 10000])
                .range([height, 0]);

            // Grid & Axes
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));

            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .style('color', '#9CA3AF');

            svg.append('g')
                .call(d3.axisLeft(yScale))
                .style('color', '#9CA3AF');

            const line = d3.line()
                .x((d, i) => xScale(i))
                .y(d => yScale(d))
                .curve(d3.curveMonotoneX);

            // Acceleration lines
            if (trial.accLeft) {
                svg.append('path')
                    .datum(trial.accLeft.slice(0, validIdx))
                    .attr('fill', 'none')
                    .attr('stroke', '#3B82F6')
                    .attr('stroke-width', 2)
                    .attr('d', line);
            }

            if (trial.accRight) {
                svg.append('path')
                    .datum(trial.accRight.slice(0, validIdx))
                    .attr('fill', 'none')
                    .attr('stroke', '#10B981')
                    .attr('stroke-width', 2)
                    .attr('d', line);
            }
        }

        #exportSession(sessionIdx) {
            const session = this.#sessions[sessionIdx];
            const csv = this.#sessionToCSV(session);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = session.filename.replace('.json', '.csv');
            a.click();
            URL.revokeObjectURL(url);
            this.success('Session exported');
        }

        #exportAll() {
            const filtered = this.#getFilteredSessions();
            const csv = filtered.map(s => this.#sessionToCSV(s, false)).join('\n\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `topbox_all_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            this.success(`Exported ${filtered.length} sessions`);
        }

        #sessionToCSV(session, includeHeader = true) {
            const headers = ['Participant', 'Condition', 'Size', 'Date', 'Time', 'Trial', 'Valid', 'RT', 'Move', 'Hand'];
            const rows = session.trials.map(t => [
                session.meta.participant,
                session.meta.condition,
                session.meta.size,
                session.meta.date,
                session.meta.time,
                t.id,
                t.isValid ? 'Yes' : 'No',
                t.hitTime || '',
                t.moveTime || '',
                t.hitHand || ''
            ]);

            return includeHeader
                ? [headers, ...rows].map(r => r.join(',')).join('\n')
                : rows.map(r => r.join(',')).join('\n');
        }

        #reset() {
            this.#sessions = [];
            this.#selectedTrial = null;
            $('#drop-zone-container').show();
            $('#results-container').hide();
            $('#header-actions').hide();
            $('#file-input').el.value = '';
            this.info('Reset complete');
        }
    }

    new TopBoxMultiAnalyzer();
</script>
</body>
</html>